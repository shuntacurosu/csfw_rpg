synchronizations:
  - name: InitMap
    when:
      source: GameLoop
      event: Initialized
    then:
      - target: MapSystem
        action: load
        payload:
          map_file: "assets/data/maps.json"
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"
      - target: NpcSystem
        action: load # Load NPCs on init
        payload: {}

  - name: GameLoopUpdate
    when:
      source: GameLoop
      event: Update
    then:
      - target: InputSystem
        action: check_input

  - name: HandleMovement
    when:
      source: InputSystem
      event: Move
    then:
      - target: Player
        action: initiate_move # Request move first
        payload:
          dx: event.dx
          dy: event.dy

  - name: CheckCollision
    when:
      source: Player
      event: CheckCollision
    then:
      - target: MapSystem
        action: validate_move
        payload:
          x: event.x
          y: event.y

  - name: ConfirmMovement
    when:
      source: MapSystem
      event: MoveValid
    then:
      - target: Player
        action: confirm_move
        payload:
          x: event.x
          y: event.y

  - name: HandleAction
    when:
      source: InputSystem
      event: Action
    then:
      - target: Player
        action: interact

  - name: PlayerInteraction
    when:
      source: Player
      event: InteractionAttempt
    then:
      - target: NpcSystem
        action: check_interaction
        payload:
          x: event.x
          y: event.y
          w: event.w
          h: event.h



  - name: RegisterNpcObstacle
    when:
      source: NpcSystem
      event: NpcSpawned
    then:
      - target: MapSystem
        action: register_obstacle
        payload:
          x: event.x
          y: event.y
          w: 16 # hardcoded assumption
          h: 16

  - name: GameLoopDraw
    when:
      source: GameLoop
      event: Draw
    then:
      - target: MapSystem
        action: draw # Assuming MapSystem has draw (Need to add it!)
      - target: Player
        action: draw # Need to add draw action to Player
      - target: NpcSystem
        action: draw # Need to add draw action
