synchronizations:
  - name: InitMap
    when:
      source: GameLoop
      event: Initialized
    then:
      - target: MapSystem
        action: load
        payload:
          map_file: "assets/data/maps.json"
      - target: Player
        action: load
      - target: BattleSystem
        action: load
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"
      - target: NpcSystem
        action: load # Load NPCs on init
        payload: {}

  - name: GameLoopUpdate
    when:
      source: GameLoop
      event: Update
    then:
      - target: InputSystem
        action: check_input

  - name: SyncGameStateToInput
    when:
      source: GameState
      event: StateChanged
    then:
      - target: InputSystem
        action: update_state
        payload:
          state: event.state

  - name: HandleMovement
    when:
      source: InputSystem
      event: Move
    then:
      - target: Player
        action: initiate_move # Request move first
        payload:
          dx: event.dx
          dy: event.dy

  - name: CheckCollision
    when:
      source: Player
      event: CheckCollision
    then:
      - target: MapSystem
        action: validate_move
        payload:
          x: event.x
          y: event.y

  - name: ConfirmMovement
    when:
      source: MapSystem
      event: MoveValid
    then:
      - target: Player
        action: confirm_move
        payload:
          x: event.x
          y: event.y

  - name: HandleAction
    condition: "get_concept('GameState').current_state == 'EXPLORING'"
    when:
      source: InputSystem
      event: Action
    then:
      - target: Player
        action: interact

  - name: PlayerInteraction
    when:
      source: Player
      event: InteractionAttempt
    then:
      - target: NpcSystem
        action: check_interaction
        payload:
          x: event.x
          y: event.y
          w: event.w
          h: event.h



  - name: RegisterNpcObstacle
    when:
      source: NpcSystem
      event: NpcSpawned
    then:
      - target: MapSystem
        action: register_obstacle
        payload:
          x: event.x
          y: event.y
          w: 16 # hardcoded assumption
          h: 16

  - name: CheckEncounter
    when:
      source: Player
      event: CheckEncounter
    then:
      - target: MapSystem
        action: check_encounter
        payload:
          x: event.x
          y: event.y

  - name: HandleMapBattle
    when:
      source: MapSystem
      event: BattleStarted
    then:
       - target: GameState
         action: change_state
         payload:
           state: "BATTLE"
       - target: BattleSystem
         action: start_battle
         payload:
           enemies: event.enemies

  - name: HandleMapChangeNPC
    when:
      source: MapSystem
      event: MapLoaded
    then:
      - target: NpcSystem
        action: load
        payload:
          map_id: event.map_id

  - name: HandleBattleStart
    when:
      source: BattleSystem
      event: BattleStarted
    then:
      - target: GameState
        action: change_state
        payload:
          state: "BATTLE"
      - target: BattleSystem
        action: start_battle
        payload:
          enemies: event.enemies

  - name: HandleBattleInput
    when:
      source: InputSystem
      event: BattleCommand
    then:
      - target: BattleSystem
        action: handle_input
        payload:
          command: event.command

  - name: HandleBattleEnd
    when:
      source: BattleSystem
      event: BattleEnded
    then: [] # Wait for acknowledgement

  - name: HandleBattleAcknowledge
    when:
      source: BattleSystem
      event: ResultAcknowledged
    then:
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"
      - target: BattleSystem
        action: end_battle

  - name: HandleTurn
    when:
      source: BattleSystem
      event: TurnAction
    then:
      - target: BattleSystem
        action: process_turn
        payload:
          entity: event.entity
          action: event.action

  - name: HandleCameraMapLoad
    when:
      source: MapSystem
      event: MapLoaded
    then:
      - target: CameraSystem
        action: set_bounds
        payload:
          width: event.width
          height: event.height 

  - name: HandleCameraFollow
    when:
      source: Player
      event: Moved
    then:
      - target: CameraSystem
        action: follow_player
        payload:
          x: event.x
          y: event.y

  - name: HandleMenuInput
    when:
       source: InputSystem
       event: MenuInput
    then:
       - target: MenuSystem
         action: handle_input
         payload:
            key: event.key

  - name: HandleMenuState
    when:
      source: MenuSystem
      event: MenuOpened
    then:
      - target: GameState
        action: change_state
        payload:
          state: "MENU"
          
  - name: HandleMenuClose
    when:
      source: MenuSystem
      event: MenuClosed
    then:
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"

  - name: SyncStatsToMenu
    when:
      source: Player
      event: StatChanged
    then:
      - target: MenuSystem
        action: update_player_data
        payload:
           hp: event.hp
           max_hp: event.max_hp
           atk: event.atk
           def: event.def_stat
           spd: event.spd
           level: event.level
           xp: event.xp
           next_xp: event.next_xp
           gold: event.gold
           inventory: event.inventory
           equipment: event.equipment

  - name: SyncGoldToShop
    when:
      source: Player
      event: StatChanged
    then:
      - target: ShopSystem
        action: update_player_gold
        payload:
           gold: event.gold

  - name: GameLoopDraw
    when:
        source: GameLoop
        event: Draw
    then:
        - target: CameraSystem
          action: apply
        - target: MapSystem
          action: draw
        - target: Player
          action: draw
        - target: NpcSystem
          action: draw
        - target: BattleSystem
          action: draw
        - target: ShopSystem
          action: draw
        - target: MenuSystem
          action: draw

  - name: HandleDialogOpen
    when:
      source: NpcSystem
      event: DialogStarted
    then:
      - target: GameState
        action: change_state
        payload:
          state: "DIALOG"

  - name: HandleShopStart
    condition: "event.npc_id in [3, 6]"
    when:
      source: NpcSystem
      event: DialogEnded
    then:
      - target: NpcSystem
        action: clear_dialog
      - target: GameState
        action: change_state
        payload:
          state: "SHOP"
      - target: ShopSystem
        action: open_shop
        payload:
          npc_id: event.npc_id

  - name: HandleDialogForward
    condition: "get_concept('GameState').current_state == 'DIALOG'"
    when:
      source: InputSystem
      event: Action
    then:
      - target: NpcSystem
        action: advance_dialog

  - name: HandleDialogClose
    condition: "event.npc_id not in [3, 6]"
    when:
      source: NpcSystem
      event: DialogEnded
    then:
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"
      - target: NpcSystem
        action: clear_dialog

  - name: HandleShopInput
    condition: "get_concept('GameState').current_state == 'SHOP'"
    when:
      source: InputSystem
      event: MenuInput
    then:
      - target: ShopSystem
        action: handle_input
        payload:
          key: event.key

  - name: HandleItemBought
    when:
      source: ShopSystem
      event: ItemBought
    then:
      - target: Player
        action: add_to_inventory
        payload:
          item: event.item

  - name: HandleShopClose
    when:
      source: ShopSystem
      event: ShopClosed
    then:
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"

  - name: HandleBattleVictory
    condition: "event.result == 'WIN'"
    when:
      source: BattleSystem
      event: BattleEnded
    then:
      - target: Player
        action: add_xp
        payload:
          amount: event.xp

  - name: HandleLevelUpNotification
    when:
      source: Player
      event: LevelUp
    then:
      - target: BattleSystem
        action: notify_levelup

  - name: HandleEquip
    when:
      source: MenuSystem
      event: EquipItem
    then:
      - target: Player
        action: equip_item
        payload:
          slot: event.slot
          item: event.item
