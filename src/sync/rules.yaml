synchronizations:
  - name: InitMap
    when:
      source: GameLoop
      event: Initialized
    then:
      - target: MapSystem
        action: load
        payload:
          map_file: "assets/data/maps.json"
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"
      - target: NpcSystem
        action: load # Load NPCs on init
        payload: {}

  - name: GameLoopUpdate
    when:
      source: GameLoop
      event: Update
    then:
      - target: InputSystem
        action: check_input

  - name: SyncGameStateToInput
    when:
      source: GameState
      event: Changed
    then:
      - target: InputSystem
        action: update_state
        payload:
          state: event.state

  - name: HandleMovement
    when:
      source: InputSystem
      event: Move
    then:
      - target: Player
        action: initiate_move # Request move first
        payload:
          dx: event.dx
          dy: event.dy

  - name: CheckCollision
    when:
      source: Player
      event: CheckCollision
    then:
      - target: MapSystem
        action: validate_move
        payload:
          x: event.x
          y: event.y

  - name: ConfirmMovement
    when:
      source: MapSystem
      event: MoveValid
    then:
      - target: Player
        action: confirm_move
        payload:
          x: event.x
          y: event.y

  - name: HandleAction
    when:
      source: InputSystem
      event: Action
    then:
      - target: Player
        action: interact

  - name: PlayerInteraction
    when:
      source: Player
      event: InteractionAttempt
    then:
      - target: NpcSystem
        action: check_interaction
        payload:
          x: event.x
          y: event.y
          w: event.w
          h: event.h



  - name: RegisterNpcObstacle
    when:
      source: NpcSystem
      event: NpcSpawned
    then:
      - target: MapSystem
        action: register_obstacle
        payload:
          x: event.x
          y: event.y
          w: 16 # hardcoded assumption
          h: 16

  - name: CheckEncounter
    when:
      source: Player
      event: CheckEncounter
    then:
      - target: MapSystem
        action: check_encounter
        payload:
          x: event.x
          y: event.y

  - name: HandleMapBattle
    when:
      source: MapSystem
      event: BattleStarted
    then:
       - target: GameState
         action: change_state
         payload:
           state: "BATTLE"
       - target: BattleSystem
         action: start_battle
         payload:
           enemies: event.enemies

  - name: HandleMapChangeNPC
    when:
      source: MapSystem
      event: MapLoaded
    then:
      - target: NpcSystem
        action: load
        payload:
          map_id: event.map_id

  - name: HandleBattleStart
    when:
      source: BattleSystem
      event: BattleStarted
    then:
      - target: GameState
        action: change_state
        payload:
          state: "BATTLE"
      - target: BattleSystem
        action: start_battle
        payload:
          enemies: event.enemies

  - name: HandleBattleInput
    when:
      source: InputSystem
      event: BattleCommand
    then:
      - target: BattleSystem
        action: handle_input
        payload:
          command_idx: event.command_idx

  - name: HandleBattleEnd
    when:
      source: BattleSystem
      event: BattleEnded
    then:
      - target: GameState
        action: change_state
        payload:
          state: "EXPLORING"
      - target: BattleSystem
        action: end_battle

  - name: HandleTurn
    when:
      source: BattleSystem
      event: TurnAction
    then:
      - target: BattleSystem
        action: process_turn
        payload:
          entity: event.entity
          action: event.action

  - name: HandleCameraMapLoad
    when:
      source: MapSystem
      event: MapLoaded
    then:
      - target: CameraSystem
        action: set_bounds
        payload:
          width: event.width
          height: event.height 

  - name: HandleCameraFollow
    when:
      source: Player
      event: Moved
    then:
      - target: CameraSystem
        action: follow_player
        payload:
          x: event.x
          y: event.y

  - name: GameLoopDraw
    when:
      source: GameLoop
      event: Draw
    then:
      - target: CameraSystem
        action: apply
      - target: MapSystem
        action: draw 
      - target: Player
        action: draw 
      - target: NpcSystem
        action: draw 
      - target: BattleSystem
        action: draw
