<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>CSFW RPG - Web Version</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
</head>

<body style="background-color: #1a1a2e; color: white; font-family: monospace; text-align: center; padding-top: 50px;">
    <div id="loading">
        <h1>CSFW RPG</h1>
        <p id="status">Loading Pyodide...</p>
    </div>
    <div id="canvas-container"></div>
    <script>
        async function main() {
            const status = document.getElementById('status');

            try {
                // Load Pyodide
                status.textContent = 'Loading Pyodide...';
                const pyodide = await loadPyodide();

                // Install packages via micropip
                status.textContent = 'Installing packages...';
                await pyodide.loadPackage('micropip');
                const micropip = pyodide.pyimport('micropip');

                // Install required packages
                status.textContent = 'Installing pyyaml...';
                await micropip.install('pyyaml');

                status.textContent = 'Installing cs-framework...';
                await micropip.install('cs-framework>=0.1.6');

                status.textContent = 'Installing pyxel...';
                await micropip.install('pyxel');

                // Download and Setup Game Package
                status.textContent = 'Downloading game data...';
                const response = await fetch('src.pyxapp');
                const buffer = await response.arrayBuffer();
                pyodide.FS.writeFile('/src.pyxapp', new Uint8Array(buffer));

                // Run the game
                status.textContent = 'Starting game...';
                document.getElementById('loading').style.display = 'none';

                // Set up environment and run
                // Adding src.pyxapp to sys.path allows importing modules from inside the zip
                const code = `
import sys
import os
import pyxel


# Add the pyxapp to sys.path
# sys.path.insert(0, "/src.pyxapp")
# sys.path.insert(0, "/src.pyxapp/src") 

# Extract the zip file to the file system
# This avoids issues with zipimport not handling subdirectories in sys.path
import zipfile
import os
import sys

print("Extracting src.pyxapp...")
with zipfile.ZipFile('/src.pyxapp', 'r') as z:
    z.extractall('/')

# Now the files are at /src/main.py, /src/concepts/..., etc.
# We need to add /src to sys.path so 'concepts' module can be found
sys.path.insert(0, "/src")

# Important: Switch to the directory so relative paths work if any
os.chdir("/")

print("Files in /src:", os.listdir("/src"))

# Execute main.py
import runpy
try:
    runpy.run_path("/src/main.py", run_name="__main__")
except Exception as e:
    print(f"Error executing game: {e}")
    import traceback
    traceback.print_exc()
`;
                await pyodide.runPythonAsync(code);

            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                console.error(error);
                status.style.color = 'red';
            }
        }
        main();
    </script>
</body>

</html>